<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.interesting.cypress.rbac.dao.UserDao">

    <select id="getMenu" parameterType="long" resultType="menu">
        select * from cypress.menu where id = #{id}
	</select>

    <insert id="addMenu" parameterType="user" useGeneratedKeys="true" keyProperty="id">
        insert into `menu`
        ( id,parent_id,`name`,url,permissions,type,icon,`order`)
        values
        ( #{id},#{parentId},#{name},#{url},#{type},#{icon},#{order} )
    </insert>

    <update id="updateMenu" parameterType="menu">
        update `menu`
        <set>
            <if test="parentId != null ">parent_id=#{parentId},</if>
            <if test="name != null ">`name`=#{name},</if>
            <if test="url != null ">url=#{url},</if>
            <if test="permissions != null ">permissions=#{permissions},</if>
            <if test="type != null ">type=#{type},</if>
            <if test="icon != null ">icon=#{icon},</if>
            <if test="order != null ">`order`=#{order},</if>
        </set>
        where id=#{id}
    </update>


    <delete id="deleteMenus">
        delete from `menu` where id in
        <foreach item="menuId" collection="list" open="(" separator="," close=")">
            #{menuId}
        </foreach>
        ;
        delete from role_menu where menu_id in
        <foreach item="menuId" collection="list" open="(" separator="," close=")">
            #{menuId}
        </foreach>
    </delete>


    <select id="getChildren" resultType="menu">
        select * from menu where parent_id = #{menuId}
    </select>


    <select id="getUserMenus" resultType="menu">
        SELECT m.* FROM user_role ur
        LEFT JOIN role_menu rm ON ur.role_id=rm.role_id
        LEFT JOIN menu m ON rm.menu_id=m.id
        WHERE ur.user_id=#{userId}
    </select>


</mapper>